# מדריך עדכון המערכת - הפרדה בין אדמינים ולקוחות

## מה השתנה?

המערכת עודכנה כדי להפריד בצורה ברורה בין מנהלי המערכת (אדמינים) ללקוחות:

### ✅ שינויים שבוצעו:

1. **הוסרה אפשרות ההרשמה מאדמין פאנל** - כעת רק מנהלים קיימים יכולים להתחבר
2. **נוצרו Collections נפרדים בפיירבייס**:
   - `admins` - עבור מנהלי המערכת
   - `customers` - עבור לקוחות החנות
3. **נוצר דף חשבון אישי ללקוחות** (`account.html`)
4. **הוספה אופציית "לזכור אותי"** בהתחברות לקוחות
5. **עודכנו כללי האבטחה** של Firebase

## איך להשתמש במערכת החדשה?

### 🔧 עבור המנהל (אדמין):

#### גישה לממשק הניהול:
- כניסה ל: `yourdomain.com/admin.html`
- **אין עוד אפשרות הרשמה** - רק התחברות עם חשבון קיים

#### יצירת מנהל חדש (במידת הצורך):
1. פתחי את Firebase Console
2. לכי ל-Authentication → Users
3. לחצי "Add User" והזיני פרטים
4. לכי ל-Firestore Database
5. צרי מסמך חדש ב-collection `admins` עם ה-UID מ-Authentication
6. הוסיפי את השדות:
   ```
   email: "admin@example.com"
   name: "שם המנהל"
   role: "admin"
   createdAt: (timestamp)
   isActive: true
   ```

### 👥 עבור הלקוחות:

#### גישה לחשבון אישי:
- כניסה דרך הכפתור 👤 בתפריט הראשי
- או ישירות ל: `yourdomain.com/account.html`
- אפשרות הרשמה והתחברות

#### מה הלקוחות יכולים לעשות:
- ✅ הרשמה לחשבון חדש
- ✅ התחברות לחשבון קיים עם אופציית "לזכור אותי"
- ✅ איפוס סיסמה
- ✅ מעבר אוטומטי לאתר הראשי לאחר התחברות/הרשמה
- ✅ אינדיקציה בסמל המשתמש שהם מחוברים
- ✅ התנתקות דרך תפריט נפתח בסמל המשתמש

## השינויים הטכניים

### Firebase Collections:
```
דמקה/
├── admins/          (חדש - מנהלי המערכת)
│   └── {adminId}
├── customers/       (חדש - לקוחות החנות)
│   └── {customerId}
├── products/        (ללא שינוי)
├── orders/          (ללא שינוי)
├── messages/        (ללא שינוי)
└── newsletter/      (ללא שינוי)
```

### כללי אבטחה חדשים:
- **Admins**: רק מנהלים קיימים יכולים לנהל מנהלים אחרים
- **Customers**: לקוחות יכולים לנהל את הנתונים שלהם בלבד
- **Orders**: לקוחות רואים רק את ההזמנות שלהם
- **Products**: כולם יכולים לראות, רק אדמינים יכולים לערוך

## מה צריך לעשות עכשיו?

### 1. העברת נתונים קיימים (אם יש):
אם יש לך משתמשים קיימים ב-collection `users`, תצטרכי להעביר אותם:

```javascript
// קוד לביצוע בקונסול הדפדפן באדמין פאנל
async function migrateUsers() {
    const usersSnapshot = await db.collection('users').get();
    
    for (const doc of usersSnapshot.docs) {
        const userData = doc.data();
        const userId = doc.id;
        
        if (userData.role === 'admin') {
            // העבר לcollection admins
            await db.collection('admins').doc(userId).set(userData);
        } else {
            // העבר לcollection customers (או צרי כ-customer)
            await db.collection('customers').doc(userId).set({
                ...userData,
                role: 'customer'
            });
        }
    }
    
    console.log('Migration completed!');
}

// הרצי את הפונקציה
migrateUsers();
```

### 2. עדכון כללי האבטחה:
העתיקי את הכללים החדשים מ-`FIREBASE_SECURITY_RULES.md` ל-Firebase Console:
1. לכי ל-Firestore Database → Rules
2. החליפי את הכללים הקיימים
3. לחצי "Publish"

### 3. בדיקת המערכת:
- ✅ נסי להתחבר כאדמין ב-`admin.html`
- ✅ נסי ליצור חשבון לקוח ב-`account.html`
- ✅ בדקי אופציית "לזכור אותי" - עם וללא סימון
- ✅ בדקי שהסמל 👤 הופך ירוק עם נקודה כשמחובר
- ✅ בדקי שיש תפריט התנתקות כשלוחצים על הסמל
- ✅ בדקי שהלקוחות רואים רק את ההזמנות שלהם  
- ✅ בדקי שהאדמין רואה הכל

## פתרון בעיות

### אם יש שגיאות גישה:
1. וודאי שהמנהל קיים ב-collection `admins` (לא `users`)
2. בדקי שכללי האבטחה עודכנו
3. נקי cache של הדפדפן

### אם הלקוחות לא יכולים להירשם:
1. בדקי שכללי האבטחה מאפשרים יצירת customers
2. וודאי שהפונקציה `registerCustomer` זמינה

### לוגים ובדיקות:
- פתחי Developer Tools → Console לראות שגיאות
- בדקי את Firestore rules במקרה של שגיאות הרשאה

## התכונה החדשה: "לזכור אותי"

### איך זה עובד:

**בהתחברות עם סימון "לזכור אותי":**
- ✅ הלקוח נשאר מחובר לתמיד (עד התנתקות ידנית)
- ✅ גם אם סוגר את הדפדפן ופותח מחדש - עדיין מחובר
- ✅ גם אם המחשב נכבה - עדיין מחובר
- ✅ רק כשלוחץ "התנתקות" הוא מתנתק

**בהתחברות ללא סימון "לזכור אותי":**
- ⚠️ הלקוח נשאר מחובר רק עד סגירת הטאב/דפדפן
- ⚠️ כל פתיחה חדשה של הדפדפן - צריך להתחבר מחדש
- ⚠️ עם רענון הדף - עדיין מחובר (רק בטאב הנוכחי)

### אינדיקציות חזותיות:

1. **סמל המשתמש** 👤:
   - **לא מחובר**: סמל ריק (far fa-user)
   - **מחובר**: סמל מלא וירוק + נקודה ירוקה קטנה

2. **תפריט נפתח** (כשלוחצים על סמל מחובר):
   - שם המשתמש
   - כפתור התנתקות אדום

3. **הודעות**:
   - הודעת ברכה כשמתחבר: "שלום [שם], התחברת בהצלחה! 🎉"
   - הודעת התנתקות: "התנתקת בהצלחה"

## יתרונות המערכת החדשה

- 🔐 **אבטחה משופרת** - הפרדה ברורה בין מנהלים ולקוחות
- 📊 **ניהול טוב יותר** - מעקב נפרד על כל סוג משתמש
- 🎯 **חוויית משתמש משופרת** - לקוחות חוזרים לקנייה מיד אחרי הרשמה
- 🚀 **גמישות** - אפשרות להוסיף תכונות שונות לכל קבוצה
- 🛒 **זרימת קנייה חלקה** - אין עיכובים מיותרים במסלול הרכישה
- 🔒 **בקרת התמדה** - לקוחות בוחרים אם להישאר מחוברים או לא

## תמיכה

אם יש בעיות או שאלות:
1. בדקי את הקונסול לשגיאות
2. וודאי שכל השלבים בוצעו
3. נסי לנקות cache ולרענן את הדף

**הערה**: המערכת הישנה תמשיך לעבוד עד שתעדכני את כללי האבטחה, אז יש לך זמן לבדוק הכל לפני העדכון הסופי. 